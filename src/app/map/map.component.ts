import { Component, AfterViewInit, OnInit } from '@angular/core';
import * as L from 'leaflet';
import { PopupService } from '../popup.service';


@Component({
  selector: 'app-map',
  templateUrl: './map.component.html',
  styleUrls: ['./map.component.css']
})
export class MapComponent implements OnInit {
  
  map: any;
  myGeoJson: any;
  
  private initializeMap(): void {
    this.map = L.map('map', {
      center: [ 40.730610, -73.935242 ],
      zoom: 8
    });
    
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      minZoom: 3,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    });

    tiles.addTo(this.map);

    
    function getColor(SV_Index2: any) {
      return SV_Index2 > 1  ? '#006400' :
      SV_Index2 > 0.9  ? '#008000' :
      SV_Index2 > 0.8  ? '#ADFF2F' :
      SV_Index2 > 0.7  ? '#90EE90' :
      SV_Index2 > 0.6  ? '#F0E68C' :
      SV_Index2 > 0.5  ? '#FFA07A' :
      SV_Index2 > 0.4  ? '#FD8D3C' :
      SV_Index2 > 0.3   ? '#FF6347' :
      SV_Index2 > 0.2   ? '#FF4500' :
      SV_Index2 > 0.1   ? '#8B4513' :
                        '#FFEDA0';
      
    }
    function style(feature: any) {
      return {
          fillColor: getColor(feature.properties.SV_Index2),
          weight: 2,
          opacity: 1,
          color: 'white',
          dashArray: '3',
          fillOpacity: 0.7
          
          
      };
    }
    
    L.geoJSON(this.myGeoJson.features, {style: style}).addTo(this.map);

    
   
    var layerGroup = L.geoJSON(this.myGeoJson, {
      onEachFeature: function (feature, layer) {
        layer.on('click', function() {layer.bindPopup('<p>Pop_T:'+feature.properties.Pop_T+'</p><p>PopDense:'+feature.properties.PopDense+'</p><p>Prcnt_U18:'+feature.properties.Prcnt_U18+'</p><p>Under18:'+feature.properties.Under18+'</p><p>Over65:'+feature.properties.Over65+'</p><p>Prcnt_HHBM:'+feature.properties.Prcnt_HHBM+'</p><p>Prcnt_Lng:'+feature.properties.Prcnt_Lng+'</p><p>PoorEng:'+feature.properties.PoorEng+'</p><p>Minority:'+feature.properties.Minority+'</p><p>Non_white:'+feature.properties.Non_white+'</p><p>Occ_HU:'+feature.properties.Occ_HU+'</p><p>HU:'+feature.properties.HU+'</p>')} )
        layer.bindPopup('<p>NAMELSAD10:'+feature.properties.NAMELSAD10+'</p><p>State: '+feature.properties.State+'</p><p>County: '+feature.properties.County+'</p><p>Region: '+feature.properties.Region+'</p>');
        layer.on('mouseover', function() { layer.openPopup(); });
        layer.on('mouseout', function() { layer.closePopup(); });
        
      }
        
  }).addTo(this.map)};

  

  constructor(private popupService: PopupService) { }

  ngOnInit(): void {
    this.popupService.getData().subscribe(
      (response) => {                          
                this.myGeoJson = response;
                this.initializeMap();
              },
      )
  }
  
  
}